= üíæ Archivn√≠ Projekt: Vagrant, Nginx, HAProxy Load Balancer a Zabbix Monitoring

Tento repozit√°≈ô obsahuje archiv ≈ôe≈°en√≠ m√©ho vysoko≈°kolsk√©ho projektu zamƒõ≈ôen√©ho na nasazen√≠ a monitorov√°n√≠ distribuovan√© slu≈æby.

== üìã Popis Projektu

C√≠lem projektu bylo vytvo≈ôit prost≈ôed√≠ zahrnuj√≠c√≠:

* *Vagrant:* Pro automatizovan√© vytvo≈ôen√≠ a spr√°vu virtu√°ln√≠ch stroj≈Ø.
* *Nginx:* Jako webov√Ω server na back-end uzlech.
* *HAProxy:* Jako _software load balancer_ pro distribuci z√°tƒõ≈æe mezi Nginx servery.
* *Zabbix:* Pro _monitorov√°n√≠_ stavu cel√©ho syst√©mu, vƒçetnƒõ uzl≈Ø a slu≈æeb.

== ‚ö†Ô∏è Upozornƒõn√≠ - D≈Øle≈æit√©!

> [!CAUTION]
> **Archivace a funkƒçnost**
>
> Tento repozit√°≈ô slou≈æ√≠ ƒçistƒõ jako **ARCHIVACE** m√© d≈ô√≠vƒõj≈°√≠ pr√°ce.
>
> Projekt byl vyvinut v r√°mci specifick√©ho studijn√≠ho zad√°n√≠ a nemus√≠ reprezentovat souƒçasn√© *best practices* nebo b√Ωt plnƒõ v souladu s dne≈°n√≠mi verzemi softwaru.
>
> **Funkƒçnost negarantov√°na:** Kv≈Øli zastaral√Ωm verz√≠m Vagrant box≈Ø, z√°vislost√≠ nebo zmƒõn√°m v konfiguraci operaƒçn√≠ch syst√©m≈Ø nen√≠ zaruƒçeno, ≈æe po klonov√°n√≠ a spu≈°tƒõn√≠ projekt **okam≈æitƒõ a spr√°vnƒõ funguje**.
>
> Je zde ulo≈æen prim√°rnƒõ pro √∫ƒçely **dokumentace**, revize k√≥du a uchov√°n√≠ historie m√©ho akademick√©ho v√Ωvoje.

== üíª Struktura

Projekt obsahuje soubory pro:

* *Vagrantfile:* Hlavn√≠ konfiguraƒçn√≠ soubor pro virtu√°ln√≠ stroje.
* Konfiguraƒçn√≠ soubory pro Nginx, HAProxy a Zabbix (nap≈ô. v adres√°≈ôi `konfigurace/`).
* Skripty pro automatick√© zprovoznƒõn√≠.
= Nginx, proxy, loadbalancing dokumentace

== üï∞Ô∏è Historick√Ω README n√≠≈æe

== C√≠l projektu

image::Diagram.png[Diagram]

V tomto projektu se zamƒõ≈ô√≠m na problematiku nginx, proxy a loadbalancingu, spust√≠m webov√Ω dva webov√© servery, kter√© budou zprovonƒõny pomoc√≠ nginx, tyto servery budou identick√©, mezi servery a hosty bude p≈ôipojen dal≈°√≠ server funguj√≠c√≠ jako prost≈ôedn√≠k s aplikacemi Haproxy a z√°rove≈à bude monitorovat server 1 a 2 pomoc√≠ aplikace zabbix.

== Nainstalovan√© aplikace:
* Nginx
* Zabbix
* Haproxy
* Mariadb


== Konfigurace vagrant:
Vagrant file je nakonfigurov√°n, aby byli t≈ôi servery a jeden host.

[source, ruby]
----
include::Vagrantfile[]
----

== Startup soubor
Zaji≈°≈•uje, aby v≈°echny yml soubory byly pou≈æity p≈ôi spu≈°tƒõn√≠.
[source, yml]
----
include::startup.yml[]
----
    
== Copy config
Kop√≠ruje z√°kladn√≠ konfiguraci stanic.
[source, yml]
----
include::copy-config.yml[]
----
    
== Instalace nginx,maria db na s1, 2 pomoc√≠ Ansible playbook

[source, yml]
----
include::nginx-server.yml[]
----
    
== Instalace zabbix, haproxy na s3 pomoc√≠ Ansible playbook
[source, yml]
----
include::zabbix-server.yml[]
----

== Mo≈ænosti loadbalancing algoritm≈Ø

K v√Ωbƒõru, kter√Ω algoritmus bylo monoho mo≈ænost√≠, j√° jsem pou≈æil round robin, proto≈æe na internetu byl nejv√≠ce pou≈æ√≠v√°n a ovƒõ≈ôen√Ω z r≈Øzn√Ωch zdroj≈Ø a t√≠m p√°dem si mysl√≠m, ≈æe je i nejspolehlivƒõj≈°√≠.

* Round Robin: Dynamick√Ω algoritmus, dovede z√°tƒõ≈æ balancovat za bƒõhu. P≈ôesmƒõrov√°n√≠ jsou dƒõlan√° na z√°kladƒõ vyt√≠≈æen√≠ jednotliv√Ωch server≈Ø. Zajist√≠, ≈æe procesn√≠ ƒças je tak√© vyv√°≈æen. Nejv√≠ce pou≈æ√≠van√Ω algoritmus.

* Static Round Robin: Ka≈æd√Ω server je pou≈æit podle jeho vyt√≠≈æen√≠, ale oproti klasick√©mu Round Robin balancov√°n√≠ nelze zmƒõnit zat√≠≈æen√≠ serveru za bƒõhu. Na druhou stranu nem√° omezen√≠ na poƒçet balancovan√Ωch server≈Ø a v p≈ô√≠padƒõ, ≈æe se objev√≠ nov√Ω server, tak je okam≈æitƒõ pou≈æit pro novou skupinu po≈æadavk≈Ø. 

* Least Connections: Tak√© dynamick√Ω algoritmus, jako Round Robin, server, kter√Ω m√° nejm√©nƒõ p≈ôipojen√≠ je preferov√°n. Tento algoritmus je vhodn√Ω pro del≈°√≠ po≈æadavky, jako nap≈ô√≠klad pr√°ce s datab√°zemi a podobnƒõ. Nen√≠ tak vhodn√Ω pro krat≈°√≠ po≈æadavky jako http.

* Source: Zahaskuje zdrojovou IP adresua vydƒõl√≠ hodnotu zat√≠≈æen√≠m v≈°ech server≈Ø. Stejn√© klientsk√© IP se v≈ædy p≈ôipoj√≠ na stejn√© servery. Pokud se zmƒõn√≠ poƒçet server≈Ø a t√≠m p√°dem i hodnota hashe, tak se klienti budou p≈ôipojovat na server jin√Ω. Vƒõt≈°inou pou≈æ√≠v√°n v TCP, kde nemohou b√Ωt pou≈æity cookies. 

* URI: Algoritmus zahashuje buƒè levou ƒç√°st URI nebo cel√© a vydƒõl√≠ hodnotu hashe celkov√Ωm poƒçtem bƒõ≈æ√≠c√≠ch server≈Ø. Stejn√° URI budou v≈ædy p≈ôesmƒõrov√°na na stejn√Ω server, pokud servery nejsou ve  stavu down.

* URL Parameter: Statick√Ω algoritmus, lze pou≈æ√≠t pouze pro http backend. URL parametr, kter√Ω je v hledan√©m dotazuse vyhled√° v ka≈æd√©m http GET requestu. Pokud se parametr shoduje, tak se hodnota zahashuje a vydƒõl√≠ poƒçtem bƒõ≈æ√≠c√≠ch server≈Ø.

== Logy
Dal≈°√≠ d≈Øle≈æitou kapitolou projektu jsou logy. J√° osobnƒõ jsem nastavil rsyslog, aby p≈ôesmƒõrov√°val ve≈°ker√© logy pomoc√≠ templatu, do slo≈æky /vagrant/hostname/appname, jeliko≈æ v praxi si mysl√≠m, ≈æe by slo≈æka vagrant by p≈ôedstavovala vzd√°len√© ulo≈æi≈°tƒõ nesouvisej√≠c√≠ se servery. T√≠m p√°dem v p≈ô√≠padƒõ, ≈æe by nap≈ô√≠klad zhavarovaly v≈°echny servery najednou, tak nemus√≠me metodou pokus omyl nƒõjak√Ω zprovoz≈àovat, aby jsme se dostali k log≈Øm, ale jednodu≈°e si logy p≈ôeƒçteme ze zm√≠nƒõn√©ho ulo≈æi≈°tƒõ. V praxi by to mohl b√Ωt NAS server, extern√≠ ulo≈æi≈°tƒõ p≈ôipojen√© p≈ô√≠mo k nƒõjak√©mu ze server≈Ø, ... , ale pro demonstraƒçn√≠ √∫ƒçely projektu si mysl√≠m, ≈æe toto ≈ôe≈°en√≠ je postaƒçuj√≠c√≠.

==== Konfigurace rsyslog:

    $template RemoteLogs,"/vagrant/logy/%HOSTNAME%/%PROGRAMNAME%.log"
    *.* ?RemoteLogs

== Z√°lohov√°n√≠
Pro z√°lohov√°n√≠ dat jsem pou≈æil crontab.

	0 0 * * *  root mysqldump -u root -p[password] -x -A > /vagrant/zalohy/dbs.sql
	
V souƒçasnosti z√°lohuji pouze datab√°zi na serveru 3, kde se nach√°z√≠ Zabbix, z√°lohov√°n√≠ je nastaveno na jednou za 24 hodin. Na serverech 1 a 2 se datab√°ze prozat√≠m nenach√°z√≠, v budoucnu bych mohl z√°lohovat i stav aplikace bƒõ≈æ√≠c√≠ na nginx, prozat√≠m jsem se aplikaƒçn√≠ str√°nku nerozhodl dƒõlat, jeliko≈æ byla oznaƒçen√° jako nepovinn√°, tak≈æe na tƒõchto serverech nen√≠ prozat√≠m co z√°lohovat. Z√°lohy opƒõt d√°v√°m do sd√≠len√© slo≈æky vagrant a pak /zalohy. V souƒçasnosti je my≈°lenka podobn√° jako u log≈Ø, mysl√≠m si, ≈æe z√°lohovat na jin√© servery je nesmysln√© a zbyteƒçnƒõ riskatn√≠.

== Zdroje
* https://www.zabbix.com/forum/zabbix-troubleshooting-and-problems/7805-looping-during-setup
* https://stackoverflow.com/questions/43721426/zcat-failing-in-ansible-playbook
* https://www.server-world.info/en/note?os=CentOS_Stream_9&p=zabbix60&f=1
* https://www.stackpath.com/blog/load-balancing-haproxy
* http://woshub.com/haproxy-load-balancer-nginx/
* https://www.shellhacks.com/ansible-run-shell-command-on-remote-host/
* https://linuxhint.com/setup_haproxy_load_balancer_centos8/
* http://www.yamllint.com/
* https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_mariadbserver_module.html3
* https://mariadb.com/kb/en/making-backups-with-mysqldump/
* https://www.ibm.com/docs/en/aix/7.2?topic=c-crontab-command
* https://asciidoclive.com/edit/scratch/1
